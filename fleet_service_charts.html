<!DOCTYPE html>
<html lang="en">
<head>
    <style>
      .nav-btn {
        display: inline-block;
        padding: 10px 20px;
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 600;
        margin-right: 10px;
        transition: background 0.2s;
      }
      .nav-btn.charts { background: #2980b9; }
      .nav-btn.vehicle { background: #27ae60; margin-right: 0; }
    </style>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Service Cost Charts</title>
  <link rel="icon" type="image/jpeg" href="favicon.jpg">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
     /* Main page styling for layout and charts */
    body {
      font-family: 'Roboto', 'Montserrat', Arial, sans-serif;
      background: #f7f9fa url('assets/images/brays-webpage-snapshot.png') no-repeat center center fixed;
      background-size: cover;
      padding: 20px;
      position: relative;
    }
    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.3);
      z-index: 0;
      pointer-events: none;
    }
    h1 { text-align: center; color: #2c3e50; font-family: 'Montserrat', 'Roboto', Arial, sans-serif; font-weight: 900; letter-spacing: 1px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2), -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff, 1px 1px 0 #fff; }
     .container { max-width: 1000px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 2px 12px rgba(44,62,80,0.08); }
     .chart-wrapper { margin-bottom: 40px; padding: 20px; background: #f7f9fa; border-radius: 8px; }
     .chart-title { color: #2980b9; font-weight: 600; margin-bottom: 20px; font-size: 1.1rem; }
     #costChart { max-height: 400px; }
     footer { text-align: center; padding: 20px 0; color: #34495e; font-size: 0.9rem; margin-top: 40px; border-top: 1px solid #e1e7ed; }
  </style>
</head>
<body>
  <div style="text-align: center; margin: 20px 0;">
    <a href="index.html" class="nav-btn charts">‚Üê Service Log</a>
    <a href="vehicle_readiness.html" class="nav-btn vehicle">üöó Vehicle Readiness</a>
  </div>
  <div style="text-align: center; margin-bottom: 20px;">
    <!-- Removed top filter dropdown -->
  </div>
  <h1>Fleet Service Cost Analysis</h1>
  <div class="container">
    <div class="chart-wrapper">
      <div class="chart-title">Total Service Costs by Vehicle</div>
      <canvas id="costChart"></canvas>
    </div>
    <div class="chart-wrapper">
      <div class="chart-title">Service Type Distribution</div>
      <canvas id="serviceTypePieChart" style="max-height: 350px;"></canvas>
    </div>
    <div class="chart-wrapper">
      <div class="chart-title">Tires Cost Breakdown by Vehicle</div>
      <canvas id="tiresBreakdownChart" style="max-height: 350px;"></canvas>
    </div>
    <div class="chart-wrapper">
      <div class="chart-title">Monthly Maintenance Costs Trend</div>
      <canvas id="costTrendChart"></canvas>
    </div>
    <div style="margin-top: 30px; padding: 20px; background: #eaf1f7; border-radius: 8px;">
      <h3 style="margin-top: 0; color: #2c3e50; font-family: 'Montserrat', 'Roboto', Arial, sans-serif;">Cost Summary</h3>
      <div style="margin-bottom: 16px;">
        <label for="summaryServiceTypeFilter" style="font-weight: 600; color: #34495e; margin-right: 10px;">Filter by Service Type:</label>
        <select id="summaryServiceTypeFilter" style="padding: 8px 16px; border-radius: 6px; border: 1px solid #bdc3c7; font-size: 1rem;"></select>
      </div>
      <table id="summaryTable" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #2980b9; color: #fff;">
            <th style="padding: 10px; text-align: left; border: 1px solid #1a5a8a;">Vehicle ID</th>
            <th style="padding: 10px; text-align: right; border: 1px solid #1a5a8a;">Total Cost (USD)</th>
            <th style="padding: 10px; text-align: right; border: 1px solid #1a5a8a;">Entry Count</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <footer>
    <p>This page is for Data use only. Records are maintained solely by the Brays Motor Museum Shop services.<br>(See Shawn Nicholson for any clarifications)</p>
  </footer>
  <script>
    let allData = [];
    let allServiceTypes = [];
    let summaryCurrentFilter = 'All';
    // Race-inspired color palette
    const vehicleColorsPalette = [
      '#D50000', // Ferrari Red
      '#FF8700', // McLaren Papaya Orange
      '#005AFF', // Williams Blue
      '#009B3A', // Lotus Green
      '#C0C0C0', // Mercedes Silver
      '#FFD600', // Renault Yellow
      '#6DCFF6', // Gulf Blue
      /* '#FFFFFF', // Martini White (removed, no white) */
      '#1C1C4E', // Red Bull Dark Blue
      '#0033A0', // BMW Motorsport Blue
      '#A7A9AC', // Porsche Racing Grey
      '#006442', // Jaguar Racing Green
      '#e74c3c', // Extra lively
      '#3498db', // Extra lively
      '#2ecc71', // Extra lively
      '#f39c12', // Extra lively
      '#9b59b6', // Extra lively
      '#1abc9c', // Extra lively
      '#34495e', // Extra lively
      '#e67e22'  // Extra lively
    ];
    // Map vehicle IDs to colors
    let vehicleColorMap = {};

    async function fetchDataAndInit() {
      await new Promise((resolve, reject) => {
        if (typeof gapi === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://apis.google.com/js/api.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        } else { resolve(); }
      });
      await new Promise((resolve, reject) => {
        gapi.load('client', { callback: resolve, onerror: reject });
      });
      await gapi.client.init({
        apiKey: 'AIzaSyCbwWuijHsYZbe7xObLhZdZrN5y215w1mk',
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
      });
      const response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: '1LoisqqngNaheCz17KR7SmrDXOTt1V8bOD673lQRKd3Q',
        range: 'Sheet1!A2:F10000'
      });
      const rows = response.result.values || [];
      allData = rows.map(row => ({
        vehicleId: row[0] || '',
        serviceType: row[1] || '',
        serviceDate: row[2] || '',
        serviceCost: row[3] || '$0.00',
        serviceCause: row[4] || '',
        serviceNotes: row[5] || ''
      })).filter(entry => entry.vehicleId && entry.vehicleId !== '' && !entry.vehicleId.includes('TOTAL'));
      allServiceTypes = Array.from(new Set(allData.map(d => d.serviceType).filter(t => t))).sort();
      populateSummaryServiceTypeFilter();
      renderChartsAndTable();
    }

    function populateSummaryServiceTypeFilter() {
      const filter = document.getElementById('summaryServiceTypeFilter');
      filter.innerHTML = '<option value="All">All</option>';
      allServiceTypes.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type;
        opt.textContent = type;
        filter.appendChild(opt);
      });
      filter.value = summaryCurrentFilter;
      // Attach event listener here for reliability
      filter.onchange = function() {
        summaryCurrentFilter = this.value;
        renderChartsAndTable();
      };
    }

    function renderChartsAndTable() {
      // Charts always use allData
      const filteredData = allData;
      // Calculate totals by vehicle
      const vehicleTotals = {};
      const vehicleCount = {};
      const serviceTypes = {};
      const monthlyCosts = {};
      filteredData.forEach(entry => {
        const vehicleId = entry.vehicleId;
        const cost = parseFloat(entry.serviceCost.replace('$', '').replace(/,/g, '')) || 0;
        const serviceType = entry.serviceType;
        if (!vehicleTotals[vehicleId]) { vehicleTotals[vehicleId] = 0; vehicleCount[vehicleId] = 0; }
        vehicleTotals[vehicleId] += cost;
        vehicleCount[vehicleId]++;
        if (!serviceTypes[serviceType]) { serviceTypes[serviceType] = 0; }
        serviceTypes[serviceType] += cost;
        if (entry.serviceDate) {
          const date = new Date(entry.serviceDate);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyCosts[monthKey]) { monthlyCosts[monthKey] = 0; }
          monthlyCosts[monthKey] += cost;
        }
      });
      // Assign colors to vehicles
      const sortedVehicles = Object.keys(vehicleTotals).sort();
      vehicleColorMap = {};
      sortedVehicles.forEach((vehicle, idx) => {
        vehicleColorMap[vehicle] = vehicleColorsPalette[idx % vehicleColorsPalette.length];
      });
      const costs = sortedVehicles.map(v => vehicleTotals[v]);
      const vehicleBarColors = sortedVehicles.map(v => vehicleColorMap[v]);
      // Bar chart - Costs by Vehicle (filtered)
      const ctx = document.getElementById('costChart').getContext('2d');
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedVehicles,
          datasets: [{ label: 'Total Service Cost (USD)', data: costs, backgroundColor: vehicleBarColors, borderColor: vehicleBarColors, borderWidth: 1, borderRadius: 6 }]
        },
        options: { responsive: true, maintainAspectRatio: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Cost (USD)' } }, x: { ticks: { maxRotation: 45, minRotation: 0 } } } }
      });

      // Tires breakdown chart (filtered)
      const tiresData = filteredData.filter(d => d.serviceType === 'Tires');
      const tiresByVehicle = {};
      tiresData.forEach(entry => {
        const vehicleId = entry.vehicleId;
        const cost = parseFloat(entry.serviceCost.replace('$', '').replace(/,/g, '')) || 0;
        if (!tiresByVehicle[vehicleId]) tiresByVehicle[vehicleId] = 0;
        tiresByVehicle[vehicleId] += cost;
      });
      const tiresVehicles = Object.keys(tiresByVehicle).sort();
      const tiresCosts = tiresVehicles.map(v => tiresByVehicle[v]);
      const tiresColors = tiresVehicles.map(v => vehicleColorMap[v] || '#888');
      const tiresCtx = document.getElementById('tiresBreakdownChart').getContext('2d');
      tiresCtx.clearRect(0, 0, tiresCtx.canvas.width, tiresCtx.canvas.height);
      new Chart(tiresCtx, {
        type: 'pie',
        data: {
          labels: tiresVehicles,
          datasets: [{ data: tiresCosts, backgroundColor: tiresColors }]
        },
        options: { responsive: true, plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: function(context) { return context.label + ': $' + context.parsed.toFixed(2); } } } } }
      });
      // Pie chart - Service Type Distribution (filtered)
      const pieCtx = document.getElementById('serviceTypePieChart').getContext('2d');
      pieCtx.clearRect(0, 0, pieCtx.canvas.width, pieCtx.canvas.height);
      new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: Object.keys(serviceTypes),
          datasets: [{ data: Object.values(serviceTypes), backgroundColor: vehicleColorsPalette }]
        },
        options: { responsive: true, plugins: { legend: { position: 'right' }, tooltip: { callbacks: { label: function(context) { return context.label + ': $' + context.parsed.toFixed(2); } } } } }
      });
      // Line chart - Monthly Cost Trend (filtered)
      const sortedMonths = Object.keys(monthlyCosts).sort();
      const monthlyData = sortedMonths.map(m => monthlyCosts[m]);
      const trendCtx = document.getElementById('costTrendChart').getContext('2d');
      trendCtx.clearRect(0, 0, trendCtx.canvas.width, trendCtx.canvas.height);
      new Chart(trendCtx, {
        type: 'line',
        data: { labels: sortedMonths, datasets: [{ label: 'Monthly Maintenance Costs', data: monthlyData, borderColor: '#2ecc71', backgroundColor: 'rgba(46, 204, 113, 0.1)', tension: 0.4, fill: true, borderWidth: 3 }] },
        options: { responsive: true, plugins: { legend: { display: true } }, scales: { y: { beginAtZero: true, title: { display: true, text: 'Cost (USD)' } }, x: { title: { display: true, text: 'Month' } } } }
      });
      // Populate summary table (filtered by summaryCurrentFilter)
      const summaryTable = document.querySelector('#summaryTable tbody');
      summaryTable.innerHTML = '';
      let summaryFiltered = summaryCurrentFilter === 'All' ? allData : allData.filter(d => d.serviceType === summaryCurrentFilter);
      // Calculate totals by vehicle for filtered summary
      const summaryVehicleTotals = {};
      const summaryVehicleCount = {};
      summaryFiltered.forEach(entry => {
        const vehicleId = entry.vehicleId;
        const cost = parseFloat(entry.serviceCost.replace('$', '').replace(/,/g, '')) || 0;
        if (!summaryVehicleTotals[vehicleId]) { summaryVehicleTotals[vehicleId] = 0; summaryVehicleCount[vehicleId] = 0; }
        summaryVehicleTotals[vehicleId] += cost;
        summaryVehicleCount[vehicleId]++;
      });
      const summarySortedVehicles = Object.keys(summaryVehicleTotals).sort();
      summarySortedVehicles.forEach(vehicle => {
        const row = summaryTable.insertRow();
        row.innerHTML = `<td style="padding: 10px; border: 1px solid #e1e7ed;">${vehicle}</td><td style="padding: 10px; text-align: right; border: 1px solid #e1e7ed;">$${summaryVehicleTotals[vehicle].toFixed(2)}</td><td style="padding: 10px; text-align: right; border: 1px solid #e1e7ed;">${summaryVehicleCount[vehicle]}</td>`;
      });
      // Add totals row
      const totalCost = Object.values(summaryVehicleTotals).reduce((a, b) => a + b, 0);
      const totalEntries = Object.values(summaryVehicleCount).reduce((a, b) => a + b, 0);
      const totalRow = summaryTable.insertRow();
      totalRow.style.fontWeight = 'bold';
      totalRow.style.background = '#2980b9';
      totalRow.style.color = '#fff';
      totalRow.innerHTML = `<td style="padding: 10px; border: 1px solid #1a5a8a;">TOTAL</td><td style="padding: 10px; text-align: right; border: 1px solid #1a5a8a;">$${totalCost.toFixed(2)}</td><td style="padding: 10px; text-align: right; border: 1px solid #1a5a8a;">${totalEntries}</td>`;
    }


    // Add event listener for summary filter after DOM is ready and filter is populated
    // (Removed unreliable setTimeout event attachment)

    window.onload = function() { fetchDataAndInit(); };
  </script>
</body>
</html>
