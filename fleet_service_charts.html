<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Service Cost Charts</title>
  <link rel="icon" type="image/jpeg" href="favicon.jpg">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Roboto', 'Montserrat', Arial, sans-serif;
      margin: 0;
      background: #f7f9fa;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      font-family: 'Montserrat', 'Roboto', Arial, sans-serif;
      font-weight: 600;
      letter-spacing: 1px;
    }
    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(44,62,80,0.08);
    }
    .chart-wrapper {
      margin-bottom: 40px;
      padding: 20px;
      background: #f7f9fa;
      border-radius: 8px;
    }
    .chart-title {
      color: #2980b9;
      font-weight: 600;
      margin-bottom: 20px;
      font-size: 1.1rem;
    }
    #costChart {
      max-height: 400px;
    }
    .back-link {
      text-align: center;
      margin-top: 30px;
    }
    .back-link a {
      color: #2980b9;
      text-decoration: none;
      font-weight: 600;
    }
    .back-link a:hover {
      text-decoration: underline;
    }
    footer {
      text-align: center;
      padding: 20px 0;
      color: #34495e;
      font-size: 0.9rem;
      margin-top: 40px;
      border-top: 1px solid #e1e7ed;
    }
  </style>
</head>
<body>
  <h1>Fleet Service Cost Analysis</h1>
  
  <div style="text-align: center; margin: 20px 0;">
    <a href="index.html" style="display: inline-block; padding: 10px 20px; background: #2980b9; color: white; text-decoration: none; border-radius: 6px; font-weight: 600; margin-right: 10px;">‚Üê Service Log</a>
    <a href="vehicle_readiness.html" style="display: inline-block; padding: 10px 20px; background: #27ae60; color: white; text-decoration: none; border-radius: 6px; font-weight: 600;">üöó Vehicle Readiness</a>
  </div>
  
  <div class="container">
    <div class="chart-wrapper">
      <div class="chart-title">Total Service Costs by Vehicle</div>
      <canvas id="costChart"></canvas>
    </div>
    
    <div class="chart-wrapper">
      <div class="chart-title">Service Type Distribution</div>
      <canvas id="serviceTypePieChart" style="max-height: 350px;"></canvas>
    </div>
    
    <div class="chart-wrapper">
      <div class="chart-title">Monthly Maintenance Costs Trend</div>
      <canvas id="costTrendChart"></canvas>
    </div>
    
    <div style="margin-top: 30px; padding: 20px; background: #eaf1f7; border-radius: 8px;">
      <h3 style="margin-top: 0; color: #2c3e50; font-family: 'Montserrat', 'Roboto', Arial, sans-serif;">Cost Summary</h3>
      <table id="summaryTable" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background: #2980b9; color: #fff;">
            <th style="padding: 10px; text-align: left; border: 1px solid #1a5a8a;">Vehicle ID</th>
            <th style="padding: 10px; text-align: right; border: 1px solid #1a5a8a;">Total Cost (USD)</th>
            <th style="padding: 10px; text-align: right; border: 1px solid #1a5a8a;">Entry Count</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <footer>
    <p>This page is for Data use only. Records are maintained solely by the Brays Motor Museum Shop services.<br>
    (See Shawn Nicholson for any clarifications)</p>
  </footer>

  <script>
    function loadAndDisplayCharts() {
      // Load data from Google Sheets
      await new Promise((resolve, reject) => {
        if (typeof gapi === 'undefined') {
          const script = document.createElement('script');
          script.src = 'https://apis.google.com/js/api.js';
          script.onload = resolve;
          script.onerror = reject;
          document.head.appendChild(script);
        } else {
          resolve();
        }
      });
      await new Promise((resolve, reject) => {
        gapi.load('client', {
          callback: resolve,
          onerror: reject
        });
      });
      await gapi.client.init({
        apiKey: 'AIzaSyCbwWuijHsYZbe7xObLhZdZrN5y215w1mk',
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
      });
      const response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: '1LoisqqngNaheCz17KR7SmrDXOTt1V8bOD673lQRKd3Q',
        range: 'Sheet1!A2:F10000'
      });
      const rows = response.result.values || [];
      // No header row, all rows are data
      const data = rows.map(row => ({
        vehicleId: row[0] || '',
        serviceType: row[1] || '',
        serviceDate: row[2] || '',
        serviceCost: row[3] || '$0.00',
        serviceCause: row[4] || '',
        serviceNotes: row[5] || ''
      })).filter(entry => entry.vehicleId && entry.vehicleId !== '' && !entry.vehicleId.includes('TOTAL'));
      
      // Calculate totals by vehicle
      const vehicleTotals = {};
      const vehicleCount = {};
      const serviceTypes = {};
      const monthlyCosts = {};
      
      data.forEach(entry => {
        const vehicleId = entry.vehicleId;
        const cost = parseFloat(entry.serviceCost.replace('$', '').replace(/,/g, '')) || 0;
        const serviceType = entry.serviceType;
        
        // Vehicle totals
        if (!vehicleTotals[vehicleId]) {
          vehicleTotals[vehicleId] = 0;
          vehicleCount[vehicleId] = 0;
        }
        vehicleTotals[vehicleId] += cost;
        vehicleCount[vehicleId]++;
        
        // Service type distribution
        if (!serviceTypes[serviceType]) {
          serviceTypes[serviceType] = 0;
        }
        serviceTypes[serviceType] += cost;
        
        // Monthly costs
        if (entry.serviceDate) {
          const date = new Date(entry.serviceDate);
          const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
          if (!monthlyCosts[monthKey]) {
            monthlyCosts[monthKey] = 0;
          }
          monthlyCosts[monthKey] += cost;
        }
      });
      
      // Sort vehicles by name
      const sortedVehicles = Object.keys(vehicleTotals).sort();
      const costs = sortedVehicles.map(v => vehicleTotals[v]);
      
      // 1. Bar chart - Costs by Vehicle
      const ctx = document.getElementById('costChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedVehicles,
          datasets: [{
            label: 'Total Service Cost (USD)',
            data: costs,
            backgroundColor: '#2980b9',
            borderColor: '#1a5a8a',
            borderWidth: 1,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: true, position: 'top' }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Cost (USD)' }
            },
            x: {
              ticks: { maxRotation: 45, minRotation: 0 }
            }
          }
        }
      });
      
      // 2. Pie chart - Service Type Distribution
      const pieCtx = document.getElementById('serviceTypePieChart').getContext('2d');
      new Chart(pieCtx, {
        type: 'pie',
        data: {
          labels: Object.keys(serviceTypes),
          datasets: [{
            data: Object.values(serviceTypes),
            backgroundColor: [
              '#e74c3c', '#3498db', '#2ecc71', '#f39c12', 
              '#9b59b6', '#1abc9c', '#34495e', '#e67e22'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': $' + context.parsed.toFixed(2);
                }
              }
            }
          }
        }
      });
      
      // 3. Line chart - Monthly Cost Trend
      const sortedMonths = Object.keys(monthlyCosts).sort();
      const monthlyData = sortedMonths.map(m => monthlyCosts[m]);
      
      const trendCtx = document.getElementById('costTrendChart').getContext('2d');
      new Chart(trendCtx, {
        type: 'line',
        data: {
          labels: sortedMonths,
          datasets: [{
            label: 'Monthly Maintenance Costs',
            data: monthlyData,
            borderColor: '#2ecc71',
            backgroundColor: 'rgba(46, 204, 113, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: 'Cost (USD)' }
            },
            x: {
              title: { display: true, text: 'Month' }
            }
          }
        }
      });
      
      // Populate summary table
      const summaryTable = document.querySelector('#summaryTable tbody');
      summaryTable.innerHTML = '';
      
      sortedVehicles.forEach(vehicle => {
        const row = summaryTable.insertRow();
        row.innerHTML = `
          <td style="padding: 10px; border: 1px solid #e1e7ed;">${vehicle}</td>
          <td style="padding: 10px; text-align: right; border: 1px solid #e1e7ed;">$${vehicleTotals[vehicle].toFixed(2)}</td>
          <td style="padding: 10px; text-align: right; border: 1px solid #e1e7ed;">${vehicleCount[vehicle]}</td>
        `;
      });
      
      // Add totals row
      const totalCost = Object.values(vehicleTotals).reduce((a, b) => a + b, 0);
      const totalEntries = Object.values(vehicleCount).reduce((a, b) => a + b, 0);
      
      const totalRow = summaryTable.insertRow();
      totalRow.style.fontWeight = 'bold';
      totalRow.style.background = '#2980b9';
      totalRow.style.color = '#fff';
      totalRow.innerHTML = `
        <td style="padding: 10px; border: 1px solid #1a5a8a;">TOTAL</td>
        <td style="padding: 10px; text-align: right; border: 1px solid #1a5a8a;">$${totalCost.toFixed(2)}</td>
        <td style="padding: 10px; text-align: right; border: 1px solid #1a5a8a;">${totalEntries}</td>
      `;
    }
    
    window.onload = function() {
      async function loadAndDisplayCharts() {
        // Load data from Google Sheets
        await new Promise((resolve, reject) => {
          if (typeof gapi === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          } else {
            resolve();
          }
        });
        await new Promise((resolve, reject) => {
          gapi.load('client', {
            callback: resolve,
            onerror: reject
          });
        });
        await gapi.client.init({
          apiKey: 'AIzaSyCbwWuijHsYZbe7xObLhZdZrN5y215w1mk',
          discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
        });
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: '1LoisqqngNaheCz17KR7SmrDXOTt1V8bOD673lQRKd3Q',
          range: 'Sheet1!A:F'
        });
        const rows = response.result.values || [];
        // Skip header row
        const data = rows.slice(1).map(row => ({
          vehicleId: row[0] || '',
          serviceType: row[1] || '',
          serviceDate: row[2] || '',
          serviceCost: row[3] || '$0.00',
          serviceCause: row[4] || '',
          serviceNotes: row[5] || ''
        })).filter(entry => entry.vehicleId && entry.vehicleId !== '' && !entry.vehicleId.includes('TOTAL'));
        // Calculate totals by vehicle
        const vehicleTotals = {};
        const vehicleCount = {};
        const serviceTypes = {};
        const monthlyCosts = {};
        data.forEach(entry => {
          const vehicleId = entry.vehicleId;
          const cost = parseFloat(entry.serviceCost.replace('$', '').replace(/,/g, '')) || 0;
          const serviceType = entry.serviceType;
          // Vehicle totals
          if (!vehicleTotals[vehicleId]) {
            vehicleTotals[vehicleId] = 0;
            vehicleCount[vehicleId] = 0;
          }
          vehicleTotals[vehicleId] += cost;
          vehicleCount[vehicleId]++;
          // Service type distribution
          if (!serviceTypes[serviceType]) {
            serviceTypes[serviceType] = 0;
          }
          serviceTypes[serviceType] += cost;
          // Monthly costs
          if (entry.serviceDate) {
            const date = new Date(entry.serviceDate);
            const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            if (!monthlyCosts[monthKey]) {
              monthlyCosts[monthKey] = 0;
            }
            monthlyCosts[monthKey] += cost;
          }
        });
